#!/bin/bash

# Check if any ".tar.gz" file is available in the current directory
tar_file=$(ls *.tar.gz 2>/dev/null | head -n 1)
if [ -z "$tar_file" ]; then
    echo "No .tar.gz file found in the current directory."
    exit 1
fi

# Create a folder with the name of the file (without extension)
folder_name="${tar_file%.tar.gz}"
mkdir -p "$folder_name"

# Unzip the file into the new folder
tar -xzf "$tar_file" -C "$folder_name"

# Navigate into the folder where the file has been extracted
cd "$folder_name" || exit 1

# Step 4: Check if users_00000.json file is present
if [ -f "users_00000.json" ]; then
    echo "users_00000.json found."

    # Step 5: Delete the users_00000.json file
    rm "users_00000.json"
    echo "users_00000.json has been deleted."
else
    echo "users_00000.json not found."
fi

# Step 6: Copy users_00000.json from /home/ec2-user/files
cp /home/ec2-user/files/users_00000.json .
echo "Copied users_00000.json from /home/ec2-user/files."

# Go back to the parent directory
cd ..

# Create a new tar.gz file with folder name and timestamp
timestamp=$(date +"%Y%m%d%H%M%S")
tar -czf "${folder_name}_${timestamp}.tar.gz" "$folder_name"

# Delete the extracted folder to clean up
rm -rf "$folder_name"

echo "Processed and created archive: ${folder_name}_${timestamp}.tar.gz"
