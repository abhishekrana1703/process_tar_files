#!/bin/bash

# Find a .tar.gz file in the current directory
TAR_FILE=$(find . -maxdepth 1 -name "*.tar.gz" | head -n 1)

# Check if a .tar.gz file was found
if [ -z "$TAR_FILE" ]; then
    echo "No .tar.gz file found in the current directory."
    exit 1
fi

# Define the path to the JSON file and the new JSON file location
JSON_FILE="users_000001.json"
NEW_JSON_FILE_LOCATION="/home/ec2-user/json-file/users_000001.json" # Update this to the correct path of the new JSON file

# Untar the .tar.gz file
tar -xzvf "$TAR_FILE"

# Output a message indicating the extraction is complete
echo "Extraction of $TAR_FILE is complete."

# Locate the JSON file (assuming it's in the root of the extracted directory)
EXTRACTED_DIR=$(tar -tzf "$TAR_FILE" | head -1 | cut -f1 -d"/")

# Check if the JSON file exists
if [ -f "$EXTRACTED_DIR/$JSON_FILE" ]; then
    echo "JSON file exists."

    # Remove the original JSON file
    rm "$EXTRACTED_DIR/$JSON_FILE"
    echo "Original JSON file has been removed."

    # Copy the new JSON file from the specified location
    cp "$NEW_JSON_FILE_LOCATION" "$EXTRACTED_DIR/"
    echo "New JSON file has been copied from '$NEW_JSON_FILE_LOCATION' to '$EXTRACTED_DIR/."

    # Re-tar the directory into a .tar.gz file
    rm "$TAR_FILE"
    NEW_TAR_FILE="${TAR_FILE%.tar.gz}_updated.tar.gz"
    tar -czvf "$NEW_TAR_FILE" -C "$EXTRACTED_DIR" .

    # Changing ownership of the new tar file
    echo "Changing ownership of the new tar file to ec2-user"
    chown -R ec2-user:ec2-user "$NEW_TAR_FILE"
    mv "$NEW_TAR_FILE" /home/ec2-user/Automation
else
    echo "JSON file '$JSON_FILE' not found."
fi
