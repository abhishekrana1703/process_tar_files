#!/bin/bash

# Check if any ".tar.gz" file is available in the current directory
tar_file=$(ls *.tar.gz 2>/dev/null | head -n 1)
if [ -z "$tar_file" ]; then
    echo "No .tar.gz file found in the current directory."
    exit 1
fi

# Create a folder with the name of the file (without extension)
folder_name="${tar_file%.tar.gz}"
mkdir -p "$folder_name"

# Unzip the file into the new folder
tar -xzf "$tar_file" -C "$folder_name"

# Copy the users_000001.json file from the current directory into the extracted folder, replacing the existing file
if [ -f "users_000001.json" ]; then
    cp "users_000001.json" "$folder_name/"
    echo "Replaced users_000001.json in $folder_name."
else
    echo "users_000001.json not found in the current directory."
    exit 1
fi

# Create a new tar.gz file with folder name and timestamp
cd "$folder_name" || exit 1
cd ..

timestamp=$(date +"%Y%m%d%H%M%S")
tar -czf "${folder_name}_${timestamp}.tar.gz" "$folder_name"

# Delete the extracted folder to clean up
rm -rf "$folder_name"

echo "Processed and created archive: ${folder_name}_${timestamp}.tar.gz"
